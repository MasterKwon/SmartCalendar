<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>월별 근무현황 관리</title>
    
    <!-- 공통 CSS 파일 링크 -->
    <link rel="stylesheet" href="css/calendar.css">
    
    <!-- 팝업 스타일 -->
    <style>
        .popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            backdrop-filter: blur(3px);
        }
        
        .popup-content {
            background: white;
            border-radius: 15px;
            padding: 30px;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
            text-align: center;
            transform: scale(0.9);
            animation: popupShow 0.3s ease forwards;
        }
        
        @keyframes popupShow {
            to {
                transform: scale(1);
            }
        }
        
        .popup-content h3 {
            margin: 0 0 20px 0;
            color: #374151;
            font-size: 1.3em;
            font-weight: 600;
        }
        
        .date-range-display {
            background: #f8fafc;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            padding: 15px;
            margin: 20px 0;
            font-size: 1.1em;
            font-weight: 500;
            color: #1e293b;
            line-height: 1.5;
        }
        
        .popup-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 25px;
        }
        
        .popup-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.95em;
            font-weight: 600;
            transition: all 0.2s ease;
            min-width: 80px;
        }
        
        .confirm-btn {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }
        
        .confirm-btn:hover {
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }
        
        .cancel-btn {
            background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
            color: white;
        }
        
        .cancel-btn:hover {
            background: linear-gradient(135deg, #4b5563 0%, #374151 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(107, 114, 128, 0.3);
        }
        
        .popup-btn:active {
            transform: translateY(0);
        }
        
        /* 달력 그리드를 8열로 변경 (기존 7열 + 주차 1열) */
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 0px;
            background-color: #f3f4f6;
            border: 1px solid #e5e7eb;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        }
        
        /* 주차 열 스타일 - 미니멀한 디자인 */
        .weekly-header {
            background: #ffffff;
            padding: 10px 6px;
            text-align: center;
            font-weight: 500;
            color: #9ca3af;
            border-bottom: 1px solid #e5e7eb;
            border-left: 15px solid transparent;
            font-size: 0.75em;
            margin-left: 10px;
            letter-spacing: 0.5px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .weekly-cell {
            background: #ffffff;
            padding: 8px 6px;
            text-align: center;
            border: 1px solid #f3f4f6;
            border-left: 15px solid transparent;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            font-size: 0.8em;
            margin-left: 10px;
            min-height: 55px;
        }
        
        .week-number {
            display: none; /* 주차 번호 숨기기 */
        }
        
        .week-time {
            font-weight: 600;
            color: #3b82f6;
            font-size: 0.95em;
        }
        
        /* 빈 시간 데이터 스타일 */
        .week-time:empty::after {
            content: "0시간 0분";
            color: #9ca3af;
            font-weight: 400;
        }
        
        /* 원본 스타일에 맞춘 달력 톤앤매너 */
        .calendar-day.saturday .date-number,
        .calendar-day.sunday .date-number {
            color: #dc2626 !important; /* 토요일, 일요일 빨간색 */
        }
        

        
        /* 선택된 날짜 스타일 제거 */
        .calendar-day.selected {
            background-color: transparent !important;
            border-color: inherit !important;
        }
        
        .calendar-day.multi-selected {
            background-color: transparent !important;
            border-color: inherit !important;
        }
        
        /* 9번: 오늘 날짜를 원형으로 처리 - 셀 색상 완전 제거 */
        .calendar-day.today {
            background-color: #ffffff !important;
            border: 1px solid #f3f4f6 !important;
            box-shadow: none !important;
        }
        
        .calendar-day.today:not(.selected) {
            background-color: #ffffff !important;
            border: 1px solid #f3f4f6 !important;
            box-shadow: none !important;
        }
        
        /* 기존 CSS 완전 덮어쓰기 */
        .calendar-grid .calendar-day.today {
            background-color: #ffffff !important;
            border: 1px solid #f3f4f6 !important;
            box-shadow: none !important;
        }
        
        .month-view .calendar-day.today {
            background-color: #ffffff !important;
            border: 1px solid #f3f4f6 !important;
            box-shadow: none !important;
        }
        
        /* 토요일, 일요일 배경색 제거 - 원본과 동일하게 */
        .calendar-day.saturday {
            background-color: #ffffff !important;
        }
        
        .calendar-day.sunday {
            background-color: #ffffff !important;
        }
        
        .calendar-grid .calendar-day.saturday,
        .calendar-grid .calendar-day.sunday {
            background-color: #ffffff !important;
        }
        
        .calendar-day.today .date-number {
            background-color: #9ca3af !important;
            color: #ffffff !important;
            font-weight: 600 !important;
            border-radius: 4px !important;
            padding: 3px 6px !important;
            display: inline-block !important;
            margin: 2px !important;
        }
        
        /* 10번: 오늘 이전 날짜 사선 패턴 음영처리 - 원본과 동일한 느낌 */
        .calendar-day.past::after,
        .calendar-day.other-month::after,
        .calendar-day.disabled::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: repeating-linear-gradient(
                -45deg,
                transparent,
                transparent 4px,
                rgba(170, 170, 170, 0.25) 4px,
                rgba(170, 170, 170, 0.25) 5px
            );
            pointer-events: none;
            z-index: 2;
        }
        
        .calendar-day {
            position: relative !important;
        }
        
        /* 다른 달 날짜 스타일 통일 - 사선 패턴으로 */
        .calendar-day.other-month {
            background-color: #ffffff !important;
            opacity: 1 !important;
        }
        
        .month-view .calendar-day.other-month {
            background-color: #ffffff !important;
            opacity: 1 !important;
        }
        


        
        /* 요일 헤더를 원본과 똑같이 만들기 - 높이 255px 수준 */
        .calendar-weekday {
            background: #ffffff !important;
            padding: 10px 6px !important;
            font-weight: 400 !important;
            color: #6b7280 !important;
            border-bottom: 1px solid #f3f4f6 !important;
            font-size: 0.75em !important;
            height: 40px !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
        }
        
        .calendar-weekday.saturday,
        .calendar-weekday.sunday {
            color: #6b7280 !important;  /* 토요일, 일요일도 동일한 색상 */
            background: #ffffff !important;
        }
        
        /* 전체 글씨 크기 조정 */
        .date-number {
            font-size: 0.85em !important;
            font-weight: 400 !important;
        }
        

        
        .weekly-header {
            font-size: 0.7em !important;
            padding: 10px 6px !important;
        }
        
        .weekly-cell {
            padding: 6px 4px !important;
            min-height: 50px !important;
        }
        
        .week-time {
            font-size: 0.8em !important;
        }
        
        /* 달력 크기를 원본과 비슷하게 조정 (950x470 → 1070x680) */
        .calendar-container {
            max-width: 1070px !important;
            width: 100% !important;
            margin: 20px auto !important;
        }
        
        .calendar-grid {
            min-height: 620px !important;
        }
        
        .calendar-day {
            padding: 6px !important;
            min-height: 110px !important;
            display: flex !important;
            flex-direction: column !important;
            align-items: flex-start !important;
            justify-content: flex-start !important;
        }
        
        .date-number {
            font-size: 0.85em !important;
            font-weight: 400 !important;
            align-self: flex-start !important;
            margin-bottom: 2px !important;
            display: flex !important;
            align-items: center !important;
            gap: 4px !important;
            color: #1f2937 !important;
            z-index: 3 !important;
            position: relative !important;
        }
        
        /* 휴일 표시 (날짜 옆) */
        .holiday-indicator {
            font-size: 0.7em !important;
            color: #dc2626 !important;
            font-weight: 500 !important;
        }
        

        
        /* 두번째줄 스케줄 영역 - 고정영역 */
        .schedule-area {
            width: 100% !important;
            background-color: transparent !important;
            padding: 0 !important;
            margin-top: 2px !important;
            min-height: 16px !important;
            display: flex !important;
            flex-direction: column !important;
            gap: 1px !important;
            z-index: 3 !important;
            position: relative !important;
        }
        
        /* 일정 텍스트 스타일 - 기본은 파란색 */
        .schedule-item {
            font-size: 0.8em !important;
            color: #1d4ed8 !important;
            font-weight: 400 !important;
            line-height: 1.1 !important;
            z-index: 3 !important;
            position: relative !important;
            background-color: transparent !important;
            padding: 1px 3px !important;
            margin: 0 !important;
        }
        
        /* 시간정보가 있는 스케줄 아이템만 회색띠 + 검은색 글씨 */
        .schedule-item.time-info {
            background-color: rgba(243, 244, 246, 0.8) !important;
            border-radius: 3px !important;
            margin: 0 -6px !important;
            padding: 1px 9px !important;
            color: #000000 !important;
        }
        
        .weekly-header {
            font-size: 0.75em !important;
            padding: 10px 6px !important;
            height: 40px !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
        }
        
        .weekly-cell {
            padding: 8px 6px !important;
            min-height: 80px !important;
        }
        
        .week-time {
            font-size: 0.85em !important;
            font-weight: 400 !important;
        }
        
        /* 강제 숨김 클래스 - 공간은 유지하되 내용만 숨김 (일반 달력용) */
        .force-hidden {
            visibility: hidden !important;
            opacity: 0 !important;
            pointer-events: none !important;
        }
        
        /* 완전 제거 클래스 - 공간까지 완전히 제거 (4주 달력용) */
        .completely-hidden {
            display: none !important;
        }
        
        /* 달력확장으로 표시되는 1,6행 전용 음영 (4주 모드) - 차분한 사선 패턴 */
        .calendar-day.week-extension::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: repeating-linear-gradient(
                45deg,
                transparent,
                transparent 3px,
                rgba(107, 114, 128, 0.2) 3px,
                rgba(107, 114, 128, 0.2) 4px
            );
            pointer-events: none;
            z-index: 4; /* 과거 날짜 음영(z-index: 2)보다 높게 설정 */
        }

    </style>
    
    <!-- 공통 JavaScript 파일 링크 -->
    <script src="js/CalendarCore.js"></script>
</head>
<body>
    <div class="calendar-container">
        <div class="calendar-header">
            <div class="calendar-title">월별계획</div>
            <div class="date-range" id="dateRange"></div>
        </div>
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
            <label style="display: flex; align-items: center; gap: 6px; font-size: 0.9em; color: #6b7280; cursor: pointer;">
                <input type="checkbox" id="showFullWeeksCheckbox" style="margin: 0;">
                <span>달력확장</span>
            </label>
            <div class="calendar-controls" style="margin: 0;">
                <button id="prevBtn">이전</button>
                <button id="todayBtn">오늘</button>
                <button id="referenceBtn" style="display: none;">기준일자</button>
                <button id="nextBtn">다음</button>
            </div>
        </div>
        <div class="calendar-grid with-weekly" id="calendarGrid">
            <!-- 요일 헤더와 날짜가 여기에 동적으로 추가됩니다 -->
        </div>
    </div>

    <!-- 날짜 선택 확인 팝업 -->
    <div id="dateRangePopup" class="popup-overlay" style="display: none;">
        <div class="popup-content">
            <h3>선택된 날짜 범위</h3>
            <div id="selectedDateRange" class="date-range-display"></div>
            <div class="popup-buttons">
                <button id="confirmSelection" class="popup-btn confirm-btn">확인</button>
                <button id="cancelSelection" class="popup-btn cancel-btn">취소</button>
            </div>
        </div>
    </div>

    <script>
        // CalendarCore 로딩 확인
        if (typeof CalendarCore === 'undefined') {
            alert('CalendarCore.js 파일을 로드할 수 없습니다.');
            throw new Error('CalendarCore.js not loaded');
        }

        console.log('✅ CalendarCore 로딩 성공:', CalendarCore);

        // 공통 로직 변수들을 안전하게 할당 (prefix 사용으로 충돌 방지)
        const coreREF_DATE = CalendarCore.REFERENCE_DATE;
        const coreWEEKDAYS = CalendarCore.WEEK_DAYS;
        const coreIsAfterRef = CalendarCore.isAfterReferenceDate;
        const coreMovePrev = CalendarCore.moveToPreviousDate;
        const coreMoveNext = CalendarCore.moveToNextDate;
        const coreGet4WeekStart = CalendarCore.get4WeekStartDate;
        const coreGet4WeekDispStart = CalendarCore.get4WeekDisplayStartDate;
        const coreGet4WeekDispEnd = CalendarCore.get4WeekDisplayEndDate;
        const coreFormatRange = CalendarCore.formatDateRange;
        const coreFormatMonthKor = CalendarCore.formatMonthDisplayKorean;

        let currentDate = new Date();
        let selectedDates = [new Date()];
        let isDragging = false;
        let dragStartDate = null;
        let dragEndDate = null;
        let dragStartCell = null;
        let isMouseDown = false;

        function initializeCalendar() {
            const calendarGrid = document.getElementById('calendarGrid');
            
            // 요일 헤더 생성 (7개)
            coreWEEKDAYS.forEach((day, index) => {
                const weekdayCell = document.createElement('div');
                weekdayCell.className = 'calendar-weekday';
                if (index === 5) weekdayCell.classList.add('saturday');
                else if (index === 6) weekdayCell.classList.add('sunday');
                weekdayCell.textContent = day;
                calendarGrid.appendChild(weekdayCell);
            });

            // 8번째 열: 주차 헤더
            const weeklyHeader = document.createElement('div');
            weeklyHeader.className = 'weekly-header';
            weeklyHeader.innerHTML = 'WEEKLY<br/>근무현황';
            calendarGrid.appendChild(weeklyHeader);

            updateCalendar();
        }

        function updateCalendar() {
            const base = new Date(2025, 8, 1);
            const nextBlock = new Date(base);
            nextBlock.setDate(base.getDate() + 28);
            
            if (coreIsAfterRef(currentDate) && currentDate < nextBlock) {
                currentDate = new Date(base);
                selectedDates = [new Date(currentDate)];
            }
            
            console.log('현재 날짜:', currentDate.toISOString().split('T')[0]);
            
            const calendarGrid = document.getElementById('calendarGrid');
            // 헤더 8개(요일 7개 + 주차 1개)는 유지하고 나머지만 제거
            while (calendarGrid.children.length > 8) {
                calendarGrid.removeChild(calendarGrid.lastChild);
            }

            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            
            if (coreIsAfterRef(currentDate)) {
                showWeekView();
                prevBtn.textContent = '이전4주';
                nextBtn.textContent = '다음4주';
            } else {
                showMonthView();
                prevBtn.textContent = '이전달';
                nextBtn.textContent = '다음달';
            }

            updateSelectedCells();
            
            // 달이 변경될 때마다 6주 표시 체크박스 상태를 다시 적용
                setTimeout(toggleWeeksDisplay, 0);
        }

        function showWeekView() {
            const calendarGrid = document.getElementById('calendarGrid');
            calendarGrid.classList.add('month-view');
            document.getElementById('dateRange').style.backgroundColor = '#dcfce7';

            const startDate = coreGet4WeekStart(currentDate);
            const displayStartDate = coreGet4WeekDispStart(startDate);
            const displayEndDate = coreGet4WeekDispEnd(displayStartDate);
            
            document.getElementById('dateRange').textContent = coreFormatRange(displayStartDate, displayEndDate);

            let weekCounter = 1;

            for (let i = 0; i < 42; i++) {
                const date = new Date(startDate);
                date.setDate(startDate.getDate() + i);

                const cell = document.createElement('div');
                cell.className = 'calendar-day';
                
                const isDisabled = i < 7 || i >= 35;
                if (isDisabled) cell.classList.add('disabled');
                
                const dayOfWeek = date.getDay();
                if (dayOfWeek === 6) cell.classList.add('saturday');
                else if (dayOfWeek === 0) cell.classList.add('sunday');
                
                const today = new Date();
                if (date.toDateString() === today.toDateString()) {
                    cell.classList.add('today');
                } else if (date < today) {
                    cell.classList.add('past');
                }
                
                if (selectedDates.some(sel => isSameDay(sel, date))) {
                    cell.classList.add('selected');
                }
                
                const dateNumber = document.createElement('div');
                dateNumber.className = 'date-number';
                
                // 날짜 번호 추가
                const dateText = document.createElement('span');
                dateText.textContent = `${date.getMonth() + 1}/${date.getDate()}`;
                dateNumber.appendChild(dateText);
                
                // 휴일 정보 추가 (날짜 옆)
                const holidayInfo = getHolidayData(date);
                if (holidayInfo) {
                    const holidaySpan = document.createElement('span');
                    holidaySpan.className = 'holiday-indicator';
                    holidaySpan.textContent = holidayInfo;
                    dateNumber.appendChild(holidaySpan);
                }
                
                cell.appendChild(dateNumber);
                
                // 일정 데이터 추가 - 고정영역으로 구조 변경
                const scheduleData = getScheduleData(date);
                const scheduleArea = document.createElement('div');
                scheduleArea.className = 'schedule-area';
                
                if (scheduleData.length > 0) {
                    cell.classList.add('has-schedule');
                    scheduleData.forEach((item, index) => {
                        const scheduleItem = document.createElement('div');
                        scheduleItem.className = 'schedule-item';
                        
                        // 첫 번째 아이템이 시간정보인지 확인
                        if (index === 0 && isTimeInfo(item)) {
                            scheduleItem.classList.add('time-info');
                        }
                        
                        scheduleItem.textContent = item;
                        scheduleArea.appendChild(scheduleItem);
                    });
                }
                
                cell.appendChild(scheduleArea);
                
                if (!cell.classList.contains('disabled')) {
                    const thisDate = new Date(date);
                    
                    // 드래그 시작 (마우스)
                    cell.addEventListener('mousedown', (e) => {
                        e.preventDefault();
                        isMouseDown = true;
                        isDragging = false;
                        dragStartDate = new Date(thisDate);
                        dragStartCell = cell;
                        console.log('드래그 시작:', dragStartDate.toISOString().split('T')[0]);
                    });
                    
                    // 드래그 진행 (마우스)
                    cell.addEventListener('mouseenter', (e) => {
                        if (isMouseDown) {
                            isDragging = true;
                            dragEndDate = new Date(thisDate);
                            const rangeDates = getDateRange(dragStartDate, dragEndDate);
                            selectedDates = rangeDates;
                            updateSelectedCells();
                            console.log('드래그 진행:', dragStartDate.toISOString().split('T')[0], '~', dragEndDate.toISOString().split('T')[0]);
                        }
                    });
                    
                    // 드래그 시작 (터치)
                    cell.addEventListener('touchstart', (e) => {
                        e.preventDefault();
                        isMouseDown = true;
                        isDragging = false;
                        dragStartDate = new Date(thisDate);
                        dragStartCell = cell;
                        console.log('터치 드래그 시작:', dragStartDate.toISOString().split('T')[0]);
                    });
                    
                    // 기존 클릭 이벤트 (드래그가 아닐 때만 실행)
                    cell.addEventListener('click', (e) => {
                        if (!isDragging) {
                            clearSelectedDates();
                            selectedDates.push(new Date(thisDate));
                            updateSelectedCells();
                            console.log('선택된 날짜:', selectedDates.map(d => d.toISOString().split('T')[0]));
                        }
                    });
                }
                calendarGrid.appendChild(cell);

                // 각 행의 끝(일요일 다음)에 주차 정보 추가
                if ((i + 1) % 7 === 0) {
                    const weeklyCell = document.createElement('div');
                    weeklyCell.className = 'weekly-cell';
                    
                    // 모든 행에 대해 주차 셀 생성 (나중에 토글로 표시/숨김 처리)
                    const weekNumber = document.createElement('div');
                    weekNumber.className = 'week-number';
                    weekNumber.textContent = `${weekCounter}주차`;
                    
                    const weekTime = document.createElement('div');
                    weekTime.className = 'week-time';
                    // 참고 이미지에 맞춘 샘플 데이터 (4주 모드에서 2~5주차 데이터 사용)
                    const weekData = {
                        1: '0시간 0분',      // 첫 주 (숨김)
                        2: '14시간 17분',    // 1주차 (4주 모드)
                        3: '12시간 0분',     // 2주차 (4주 모드)
                        4: '0시간 0분',      // 3주차 (4주 모드)
                        5: '0시간 0분',      // 4주차 (4주 모드)
                        6: '0시간 0분'       // 마지막 주 (숨김)
                    };
                    weekTime.textContent = weekData[weekCounter] || '0시간 0분';
                    
                    weeklyCell.appendChild(weekNumber);
                    weeklyCell.appendChild(weekTime);
                    
                    weekCounter++;
                    
                    calendarGrid.appendChild(weeklyCell);
                }
            }
        }

        function showMonthView() {
            const calendarGrid = document.getElementById('calendarGrid');
            const showFullWeeks = document.getElementById('showFullWeeksCheckbox').checked;
            calendarGrid.classList.add('month-view');
            document.getElementById('dateRange').style.backgroundColor = '#eaf4ff';

            const firstDay = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
            const lastDay = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0);

            document.getElementById('dateRange').textContent = coreFormatMonthKor(currentDate);

            let date = new Date(firstDay);
            const firstDayOfWeek = ((date.getDay() + 6) % 7);
            date.setDate(date.getDate() - firstDayOfWeek);

            // 항상 6주 생성 (6주 표시 여부는 CSS로 처리)
            const totalDays = 6 * 7;
            let weekCounter = 1;
            
            for (let i = 0; i < totalDays; i++) {
                const cell = document.createElement('div');
                cell.className = 'calendar-day';

                if (date < firstDay || date > lastDay) {
                    cell.classList.add('other-month');
                }

                const dayOfWeek = date.getDay();
                if (dayOfWeek === 6) cell.classList.add('saturday');
                else if (dayOfWeek === 0) cell.classList.add('sunday');

                const today = new Date();
                if (date.toDateString() === today.toDateString()) {
                    cell.classList.add('today');
                } else if (date < today) {
                    cell.classList.add('past');
                }

                const dateNumber = document.createElement('div');
                dateNumber.className = 'date-number';
                
                // 날짜 번호 추가
                const dateText = document.createElement('span');
                dateText.textContent = `${date.getMonth() + 1}/${date.getDate()}`;
                dateNumber.appendChild(dateText);
                
                // 휴일 정보 추가 (날짜 옆)
                const holidayInfo = getHolidayData(date);
                if (holidayInfo) {
                    const holidaySpan = document.createElement('span');
                    holidaySpan.className = 'holiday-indicator';
                    holidaySpan.textContent = holidayInfo;
                    dateNumber.appendChild(holidaySpan);
                }
                
                cell.appendChild(dateNumber);

                // 일정 데이터 추가 - 고정영역으로 구조 변경
                const scheduleData = getScheduleData(date);
                const scheduleArea = document.createElement('div');
                scheduleArea.className = 'schedule-area';
                
                if (scheduleData.length > 0) {
                    cell.classList.add('has-schedule');
                    scheduleData.forEach((item, index) => {
                        const scheduleItem = document.createElement('div');
                        scheduleItem.className = 'schedule-item';
                        
                        // 첫 번째 아이템이 시간정보인지 확인
                        if (index === 0 && isTimeInfo(item)) {
                            scheduleItem.classList.add('time-info');
                        }
                        
                        scheduleItem.textContent = item;
                        scheduleArea.appendChild(scheduleItem);
                    });
                }
                
                cell.appendChild(scheduleArea);

                if (!cell.classList.contains('other-month')) {
                    const thisDate = new Date(date);
                    
                    // 드래그 시작 (마우스)
                    cell.addEventListener('mousedown', (e) => {
                        e.preventDefault();
                        isMouseDown = true;
                        isDragging = false;
                        dragStartDate = new Date(thisDate);
                        dragStartCell = cell;
                        console.log('드래그 시작:', dragStartDate.toISOString().split('T')[0]);
                    });
                    
                    // 드래그 진행 (마우스)
                    cell.addEventListener('mouseenter', (e) => {
                        if (isMouseDown) {
                            isDragging = true;
                            dragEndDate = new Date(thisDate);
                            const rangeDates = getDateRange(dragStartDate, dragEndDate);
                            selectedDates = rangeDates;
                            updateSelectedCells();
                            console.log('드래그 진행:', dragStartDate.toISOString().split('T')[0], '~', dragEndDate.toISOString().split('T')[0]);
                        }
                    });
                    
                    // 드래그 시작 (터치)
                    cell.addEventListener('touchstart', (e) => {
                        e.preventDefault();
                        isMouseDown = true;
                        isDragging = false;
                        dragStartDate = new Date(thisDate);
                        dragStartCell = cell;
                        console.log('터치 드래그 시작:', dragStartDate.toISOString().split('T')[0]);
                    });
                    
                    // 기존 클릭 이벤트 (드래그가 아닐 때만 실행)
                    cell.addEventListener('click', (e) => {
                        if (!isDragging) {
                            clearSelectedDates();
                            selectedDates.push(new Date(thisDate));
                            updateSelectedCells();
                            console.log('선택된 날짜:', selectedDates.map(d => d.toISOString().split('T')[0]));
                        }
                    });
                }

                calendarGrid.appendChild(cell);
                
                // 각 행의 끝(일요일 다음)에 주차 정보 추가
                if ((i + 1) % 7 === 0) {
                    const weeklyCell = document.createElement('div');
                    weeklyCell.className = 'weekly-cell';
                    
                    const weekNumber = document.createElement('div');
                    weekNumber.className = 'week-number';
                    weekNumber.textContent = `${weekCounter}주차`;
                    
                    const weekTime = document.createElement('div');
                    weekTime.className = 'week-time';
                    // 참고 이미지에 맞춘 샘플 데이터
                    const weekData = {
                        1: '0시간 0분',      
                        2: '14시간 17분',    
                        3: '12시간 0분',     
                        4: '0시간 0분',      
                        5: '0시간 0분',      
                        6: '0시간 0분'       
                    };
                    weekTime.textContent = weekData[weekCounter] || '0시간 0분';
                    
                    weeklyCell.appendChild(weekNumber);
                    weeklyCell.appendChild(weekTime);
                    calendarGrid.appendChild(weeklyCell);
                    
                    weekCounter++;
                }
                
                date.setDate(date.getDate() + 1);
            }
        }

        function isSameDay(date1, date2) {
            return date1.getFullYear() === date2.getFullYear() &&
                date1.getMonth() === date2.getMonth() &&
                date1.getDate() === date2.getDate();
        }

        // 시간정보인지 확인하는 함수
        function isTimeInfo(text) {
            // 시간 패턴 확인: "8h5m", "4h17m", "6h", "3h" 등
            return /^\d+h(\d+m)?$/.test(text);
        }

        function getScheduleData(date) {
            const monthDay = `${date.getMonth() + 1}/${date.getDate()}`;
            const scheduleMap = {
                // 6월 데이터
                '6/2': ['8h5m', '반차(4h5m)', '태아검진(4h)'],
                '6/3': [],
                '6/4': ['8h5m', '반차(4h5m)', '태아검진(4h)'],
                '6/5': ['4h5m', '반차(4h5m)'],
                '6/6': [],
                '6/9': ['8h9m', '태아검진(4h)', '반차(4h5m)'],
                '6/10': ['6h', '태아검진(4h)'],
                '6/20': ['4h5m', '반차(4h5m)'],
                '6/26': ['5h48m'],
                // 7월 데이터
                '7/1': ['4h17m', '태아검진(4h)'],
                '7/2': ['4h', '태아검진(4h)'],
                '7/3': ['3h', '반차(3h)'],  
                '7/4': ['3h', '반차(3h)'],
                '7/7': ['6h', '반차, 태아검진(6h)'],
                '7/8': ['6h', '태아검진, 반차(6h)'],
                '7/23': ['반차(3h)'],
                '7/24': ['반차(3h)']
            };
            return scheduleMap[monthDay] || [];
        }

        function getHolidayData(date) {
            const monthDay = `${date.getMonth() + 1}/${date.getDate()}`;
            const holidayMap = {
                '6/3': '대통령 선거일',
                '6/6': '현충일'
            };
            return holidayMap[monthDay] || null;
        }

        function getDateFromCell(cell) {
            const dateNumberDiv = cell.querySelector('.date-number');
            if (dateNumberDiv) {
                const [m, d] = dateNumberDiv.textContent.split('/');
                const y = currentDate.getFullYear();
                return new Date(y, parseInt(m, 10) - 1, parseInt(d, 10));
            }
            return null;
        }

        function getDateRange(startDate, endDate) {
            const dates = [];
            const start = new Date(Math.min(startDate, endDate));
            const end = new Date(Math.max(startDate, endDate));
            
            const current = new Date(start);
            while (current <= end) {
                dates.push(new Date(current));
                current.setDate(current.getDate() + 1);
            }
            return dates;
        }

        function formatDateRangeForPopup(dates) {
            if (dates.length === 0) return '';
            
            if (dates.length === 1) {
                const date = dates[0];
                return `${date.getFullYear()}년 ${date.getMonth() + 1}월 ${date.getDate()}일`;
            }
            
            const startDate = dates[0];
            const endDate = dates[dates.length - 1];
            
            const startStr = `${startDate.getFullYear()}년 ${startDate.getMonth() + 1}월 ${startDate.getDate()}일`;
            const endStr = `${endDate.getFullYear()}년 ${endDate.getMonth() + 1}월 ${endDate.getDate()}일`;
            
            return `${startStr}\n~\n${endStr}\n\n(총 ${dates.length}일)`;
        }

        function showDateRangePopup(dates) {
            const popup = document.getElementById('dateRangePopup');
            const rangeDisplay = document.getElementById('selectedDateRange');
            
            rangeDisplay.textContent = formatDateRangeForPopup(dates);
            popup.style.display = 'flex';
        }

        function hideDateRangePopup() {
            const popup = document.getElementById('dateRangePopup');
            popup.style.display = 'none';
        }



        function clearSelectedDates() {
            selectedDates = [];
        }

        function updateSelectedCells() {
            // 달력 날짜 셀만 선택 처리 (주차 셀은 제외)
            document.querySelectorAll('.calendar-day').forEach(cell => {
                cell.classList.remove('selected', 'multi-selected');
            });
            document.querySelectorAll('.calendar-day').forEach(cell => {
                const dateNumberDiv = cell.querySelector('.date-number');
                if (dateNumberDiv) {
                    const [m, d] = dateNumberDiv.textContent.split('/');
                    const y = currentDate.getFullYear();
                    const cellDate = new Date(y, parseInt(m, 10) - 1, parseInt(d, 10));
                    if (selectedDates.some(sel => isSameDay(sel, cellDate))) {
                        if (selectedDates.length > 1) {
                            cell.classList.add('multi-selected');
                        } else {
                            cell.classList.add('selected');
                        }
                    }
                }
            });
        }

        function toggleWeeksDisplay() {
            const showFullWeeks = document.getElementById('showFullWeeksCheckbox').checked;
                const calendarGrid = document.getElementById('calendarGrid');
                const cells = calendarGrid.querySelectorAll('.calendar-day');
            const weeklyCells = calendarGrid.querySelectorAll('.weekly-cell');

            console.log('toggleWeeksDisplay 호출 - 달력확장:', showFullWeeks);
            console.log('찾은 날짜 셀 개수:', cells.length, '주차 셀 개수:', weeklyCells.length);

            if (coreIsAfterRef(currentDate)) {
                // 4주 달력: 1행, 6행 완전 제거 (공간까지 제거)
                cells.forEach((cell, index) => {
                    if (showFullWeeks) {
                        cell.classList.remove('completely-hidden');
                        if (index < 7 || index >= 35) {
                            cell.classList.add('week-extension'); // 달력확장 전용 음영
                        } else {
                            cell.classList.remove('week-extension');
                        }
                    } else {
                        if (index < 7 || index >= 35) {
                            cell.classList.add('completely-hidden');
                            cell.classList.remove('week-extension');
                            console.log('4주 달력 날짜 셀 완전 숨김:', index);
                        } else {
                            cell.classList.remove('completely-hidden');
                            cell.classList.remove('week-extension');
                        }
                    }
                });

                weeklyCells.forEach((weeklyCell, index) => {
                    if (showFullWeeks) {
                        weeklyCell.classList.remove('completely-hidden');
            } else {
                        if (index === 0 || index === 5) {
                            weeklyCell.classList.add('completely-hidden');
                            console.log('4주 달력 주차 셀 완전 숨김:', index);
                        } else {
                            weeklyCell.classList.remove('completely-hidden');
                        }
                    }
                });
            } else {
                // 일반 달력: 이번 달이 아닌 날짜만 포함된 행 숨기기
                const rowsToHide = [];
                
                // 각 행(7개씩)을 확인하여 이번 달 날짜가 포함되어 있는지 체크
                for (let row = 0; row < 6; row++) {
                    let hasCurrentMonth = false;
                    for (let col = 0; col < 7; col++) {
                        const cellIndex = row * 7 + col;
                        const cell = cells[cellIndex];
                        if (cell && !cell.classList.contains('other-month')) {
                            hasCurrentMonth = true;
                            break;
                        }
                    }
                    if (!hasCurrentMonth) {
                        rowsToHide.push(row);
                    }
                }

                console.log('숨길 행들:', rowsToHide);

                // 날짜 셀 표시/숨김 (42개)
                cells.forEach((cell, index) => {
                    const row = Math.floor(index / 7);
                    if (showFullWeeks) {
                        cell.classList.remove('force-hidden');
                        // 다른 달 날짜에 달력확장 스타일 적용
                        if (cell.classList.contains('other-month')) {
                            cell.classList.add('week-extension');
                        }
                    } else {
                        // week-extension 클래스 제거
                        cell.classList.remove('week-extension');
                        
                        if (rowsToHide.includes(row)) {
                            cell.classList.add('force-hidden');
                            console.log('날짜 셀 숨김:', index, '행:', row, cell);
                        } else {
                            cell.classList.remove('force-hidden');
                        }
                    }
                });

                // 주차 셀 표시/숨김 (6개)
                weeklyCells.forEach((weeklyCell, index) => {
                    if (showFullWeeks) {
                        weeklyCell.classList.remove('force-hidden');
                    } else {
                        if (rowsToHide.includes(index)) {
                            weeklyCell.classList.add('force-hidden');
                            console.log('주차 셀 숨김:', index);
                        } else {
                            weeklyCell.classList.remove('force-hidden');
                        }
                    }
                });
            }

            updateDateRangeDisplay();
        }

        function updateDateRangeDisplay() {
            const showFullWeeks = document.getElementById('showFullWeeksCheckbox').checked;
            if (coreIsAfterRef(currentDate)) {
                if (!showFullWeeks) {
                    const startDate = coreGet4WeekStart(currentDate);
                    const displayStartDate = coreGet4WeekDispStart(startDate);
                    const displayEndDate = coreGet4WeekDispEnd(displayStartDate);
                    document.getElementById('dateRange').textContent = coreFormatRange(displayStartDate, displayEndDate);
                } else {
                const startDate = coreGet4WeekStart(currentDate);
                const displayStartDate = coreGet4WeekDispStart(startDate);
                const displayEndDate = coreGet4WeekDispEnd(displayStartDate);
                document.getElementById('dateRange').textContent = coreFormatRange(displayStartDate, displayEndDate);
                }
            }
        }

        // 이벤트 리스너
        document.getElementById('prevBtn').addEventListener('click', () => {
            currentDate = coreMovePrev(currentDate);
            updateCalendar();
        });

        document.getElementById('nextBtn').addEventListener('click', () => {
            currentDate = coreMoveNext(currentDate);
            updateCalendar();
        });

        document.getElementById('todayBtn').addEventListener('click', () => {
            currentDate = new Date();
            updateCalendar();
        });

        document.getElementById('referenceBtn').addEventListener('click', () => {
            currentDate = new Date(coreREF_DATE);
            updateCalendar();
        });

        document.getElementById('showFullWeeksCheckbox').addEventListener('change', function() {
            console.log('체크박스 클릭됨! 현재 상태:', this.checked);
            toggleWeeksDisplay();
        });

        // 전역 드래그 종료 이벤트 리스너
        document.addEventListener('mouseup', (e) => {
            if (isMouseDown) {
                console.log('드래그 종료:', selectedDates.map(d => d.toISOString().split('T')[0]));
                
                // 드래그가 발생했고 2개 이상의 날짜가 선택되었을 때 팝업 표시
                if (isDragging && selectedDates.length > 1) {
                    showDateRangePopup(selectedDates);
                }
                
                isMouseDown = false;
                // 드래그가 발생했으면 약간의 지연 후 isDragging을 false로 설정
                // 이는 클릭 이벤트가 실행되지 않도록 하기 위함
                if (isDragging) {
                    setTimeout(() => {
                        isDragging = false;
                    }, 50);
                }
                dragStartDate = null;
                dragEndDate = null;
                dragStartCell = null;
            }
        });

        document.addEventListener('touchend', (e) => {
            if (isMouseDown) {
                console.log('터치 드래그 종료:', selectedDates.map(d => d.toISOString().split('T')[0]));
                
                // 드래그가 발생했고 2개 이상의 날짜가 선택되었을 때 팝업 표시
                if (isDragging && selectedDates.length > 1) {
                    showDateRangePopup(selectedDates);
                }
                
                isMouseDown = false;
                if (isDragging) {
                    setTimeout(() => {
                        isDragging = false;
                    }, 50);
                }
                dragStartDate = null;
                dragEndDate = null;
                dragStartCell = null;
            }
        });

        // 터치 디바이스에서의 드래그 중 처리
        document.addEventListener('touchmove', (e) => {
            if (isMouseDown) {
                e.preventDefault();
                const touch = e.touches[0];
                const element = document.elementFromPoint(touch.clientX, touch.clientY);
                
                if (element && element.classList.contains('calendar-day') && !element.classList.contains('disabled') && !element.classList.contains('other-month')) {
                    const cellDate = getDateFromCell(element);
                    if (cellDate) {
                        isDragging = true;
                        dragEndDate = new Date(cellDate);
                        const rangeDates = getDateRange(dragStartDate, dragEndDate);
                        selectedDates = rangeDates;
                        updateSelectedCells();
                        console.log('터치 드래그 진행:', dragStartDate.toISOString().split('T')[0], '~', dragEndDate.toISOString().split('T')[0]);
                    }
                }
            }
        }, { passive: false });

        // 팝업 버튼 이벤트 리스너
        document.getElementById('confirmSelection').addEventListener('click', () => {
            hideDateRangePopup();
            console.log('날짜 선택 확인:', selectedDates.map(d => d.toISOString().split('T')[0]));
            // 여기에 추가적인 처리 로직을 넣을 수 있습니다 (예: 서버 전송, 다른 함수 호출 등)
        });

        document.getElementById('cancelSelection').addEventListener('click', () => {
            hideDateRangePopup();
            clearSelectedDates();
            updateSelectedCells();
            console.log('날짜 선택 취소');
        });

        // 팝업 배경 클릭 시 닫기
        document.getElementById('dateRangePopup').addEventListener('click', (e) => {
            if (e.target.id === 'dateRangePopup') {
                hideDateRangePopup();
                clearSelectedDates();
                updateSelectedCells();
            }
        });

        // ESC 키로 팝업 닫기
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                const popup = document.getElementById('dateRangePopup');
                if (popup.style.display === 'flex') {
                    hideDateRangePopup();
                    clearSelectedDates();
                    updateSelectedCells();
                }
            }
        });

        // 초기화
        initializeCalendar();
    </script>
</body>
</html> 